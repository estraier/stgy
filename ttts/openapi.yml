openapi: 3.0.3
info:
  title: TTTS Search Service
  description: |
    TTTS (Time-series Text Tiling Search) API.
    Provides full-text search capabilities with time-series sharding logic.
    Resources (e.g., 'users', 'posts') are configured dynamically.
  version: 1.0.0
servers:
  - url: http://localhost:3200
    description: Local server

paths:
  /health:
    get:
      summary: Health check
      description: Returns the health status of the service.
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: string
                    example: ok

  /{resource}/maintenance:
    parameters:
      - $ref: "#/components/parameters/ResourcePath"
    get:
      summary: Check maintenance mode
      tags: [Management]
      responses:
        "200":
          description: Current maintenance status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceStatus"
    post:
      summary: Enable maintenance mode
      tags: [Management]
      responses:
        "200":
          description: Maintenance mode enabled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceStatus"
    delete:
      summary: Disable maintenance mode
      tags: [Management]
      responses:
        "200":
          description: Maintenance mode disabled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceStatus"

  /{resource}/flush:
    parameters:
      - $ref: "#/components/parameters/ResourcePath"
    post:
      summary: Flush pending tasks (SYNC)
      tags: [Management]
      parameters:
        - $ref: "#/components/parameters/WaitQuery"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                wait:
                  type: number
                  description: Wait time in seconds
      responses:
        "200":
          description: Flush task enqueued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"

  /{resource}/optimize:
    parameters:
      - $ref: "#/components/parameters/ResourcePath"
    post:
      summary: Optimize a specific shard
      tags: [Management]
      parameters:
        - $ref: "#/components/parameters/WaitQuery"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - timestamp
              properties:
                timestamp:
                  type: number
                  description: Target timestamp to identify the shard bucket
                wait:
                  type: number
      responses:
        "200":
          description: Optimization task enqueued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"

  /{resource}/reconstruct:
    parameters:
      - $ref: "#/components/parameters/ResourcePath"
    post:
      summary: Reconstruct a shard index
      tags: [Management]
      parameters:
        - $ref: "#/components/parameters/WaitQuery"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - timestamp
              properties:
                timestamp:
                  type: number
                newInitialId:
                  type: number
                useExternalId:
                  type: boolean
                wait:
                  type: number
      responses:
        "200":
          description: Reconstruction task enqueued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"

  /{resource}/reserve:
    parameters:
      - $ref: "#/components/parameters/ResourcePath"
    post:
      summary: Reserve document IDs (Requires Maintenance Mode)
      tags: [Management]
      parameters:
        - $ref: "#/components/parameters/WaitQuery"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - documents
              properties:
                documents:
                  type: array
                  items:
                    type: object
                    required:
                      - id
                      - timestamp
                    properties:
                      id:
                        type: string
                      timestamp:
                        type: number
                wait:
                  type: number
      responses:
        "200":
          description: Reservation task enqueued
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/TaskResponse"
                  - type: object
                    properties:
                      count:
                        type: number
        "409":
          description: Maintenance mode required

  /{resource}/shards:
    parameters:
      - $ref: "#/components/parameters/ResourcePath"
    get:
      summary: List index files (shards)
      tags: [Management]
      parameters:
        - name: detailed
          in: query
          schema:
            type: boolean
      responses:
        "200":
          description: List of index files
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/IndexFileInfo"

  /{resource}/shards/{timestamp}:
    parameters:
      - $ref: "#/components/parameters/ResourcePath"
      - name: timestamp
        in: path
        required: true
        schema:
          type: number
    delete:
      summary: Drop a specific shard
      tags: [Management]
      parameters:
        - $ref: "#/components/parameters/WaitQuery"
      responses:
        "200":
          description: Drop task enqueued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"

  /{resource}/tokenize:
    parameters:
      - $ref: "#/components/parameters/ResourcePath"
    get:
      summary: Tokenize text
      tags: [Search]
      parameters:
        - name: text
          in: query
          required: true
          schema:
            type: string
        - name: locale
          in: query
          schema:
            type: string
            default: en
      responses:
        "200":
          description: List of tokens
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /{resource}/search:
    parameters:
      - $ref: "#/components/parameters/ResourcePath"
    get:
      summary: Execute full-text search
      tags: [Search]
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
        - name: locale
          in: query
          schema:
            type: string
            default: en
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: timeout
          in: query
          schema:
            type: integer
            default: 1
      responses:
        "200":
          description: List of matching document IDs
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /{resource}/search-fetch:
    parameters:
      - $ref: "#/components/parameters/ResourcePath"
    get:
      summary: Search and fetch document details
      tags: [Search]
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
        - name: locale
          in: query
          schema:
            type: string
            default: en
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: timeout
          in: query
          schema:
            type: integer
            default: 1
        - name: omitBodyText
          in: query
          schema:
            type: boolean
        - name: omitAttrs
          in: query
          schema:
            type: boolean
      responses:
        "200":
          description: List of documents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Document"

  /{resource}/{docId}:
    parameters:
      - $ref: "#/components/parameters/ResourcePath"
      - name: docId
        in: path
        required: true
        schema:
          type: string
    get:
      summary: Fetch a single document
      tags: [Document]
      parameters:
        - name: omitBodyText
          in: query
          schema:
            type: boolean
        - name: omitAttrs
          in: query
          schema:
            type: boolean
      responses:
        "200":
          description: Document details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Document"
        "404":
          description: Document not found

    put:
      summary: Add or update a document
      tags: [Document]
      parameters:
        - $ref: "#/components/parameters/WaitQuery"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - text
                - timestamp
              properties:
                text:
                  type: string
                timestamp:
                  type: number
                locale:
                  type: string
                  default: en
                attrs:
                  type: string
                  description: JSON string of extra attributes
                wait:
                  type: number
      responses:
        "202":
          description: Task accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"

    delete:
      summary: Remove a document
      tags: [Document]
      parameters:
        - $ref: "#/components/parameters/WaitQuery"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - timestamp
              properties:
                timestamp:
                  type: number
                wait:
                  type: number
      responses:
        "202":
          description: Task accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"

components:
  parameters:
    ResourcePath:
      name: resource
      in: path
      required: true
      description: Name of the resource (e.g., users, posts)
      schema:
        type: string
    WaitQuery:
      name: wait
      in: query
      description: Wait for task completion (seconds)
      schema:
        type: number

  schemas:
    MaintenanceStatus:
      type: object
      properties:
        enabled:
          type: boolean

    TaskResponse:
      type: object
      properties:
        result:
          type: string
          example: enqueued
        taskId:
          type: string

    Document:
      type: object
      properties:
        id:
          type: string
        bodyText:
          type: string
          nullable: true
        attrs:
          type: string
          nullable: true
          description: JSON string

    IndexFileInfo:
      type: object
      properties:
        path:
          type: string
        name:
          type: string
        startTimestamp:
          type: number
        size:
          type: number
        walSize:
          type: number
